<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ussMng">	
	<!-- 사용자 조회  -->
	<select id="getUssList" resultType="hashMap" parameterType="map" >
		 SELECT
				A.USS_ID
				, A.USS_NM
				, A.USS_BIRTH
				, A.USS_EMAIL
				<!-- , A.USS_AUTH_CD --> <!-- 권한 매핑 테이블 미사용시 -->
				, B.AUTHOR_CODE AS USS_AUTH_CD	<!-- 권한 매핑 테이블 사용시 --> 
				, A.USS_AUTH_CD
				, A.USS_TEL
				, A.USS_EM_NO
				, C.AUTHOR_NM AS USS_AUTH_NM	<!-- 권한 매핑 테이블 사용시 -->
				, A.DP_CD
				, D.CD_NM AS DP_NM
				, A.EMP_TYPE
				, (SELECT S.CD_NM FROM STD_CD_MNG S WHERE S.CD = A.EMP_TYPE) AS EMP_TYPE_NM /*고용구분명칭*/
				, A.RTR_YN /*재직구분*/
			FROM
				STD_USS_MNG A
				<!-- LEFT OUTER JOIN STD_AUT_INFO B ON B.AUTHOR_CODE = A.USS_AUTH_CD --><!-- 사용자테이블에 권한 컬럼 사용시 및 권한 매핑 테이블 미사용 -->
				LEFT OUTER JOIN STD_AUT_ROLE_MAP B ON A.USS_ID = B.SCRTY_DTRMN_TRGET_ID
				LEFT OUTER JOIN STD_AUT_INFO C ON C.AUTHOR_CODE = B.AUTHOR_CODE
				LEFT OUTER JOIN STD_CD_MNG D ON D.CD = A.DP_CD
		<where>
			1=1
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND A.USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND A.USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
			<!-- 재직구분 -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun2)" >
				AND A.RTR_YN = #{searchGubun2}
			</if>
			<!-- 고용구분 -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun3)" >
				AND A.EMP_TYPE = #{searchGubun3} 
			</if>
			<!-- 부서코드  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun4)" >
				AND A.DP_CD = #{searchGubun4}
			</if>
			<!-- 직급(권한)코드  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun5)" >
				AND A.USS_AUTH_CD = #{searchGubun5}
			</if>
		</where>
		ORDER BY REG_DT DESC
	</select>
	<!-- 사용자 총건수  -->
	<select id="getUssTotCount" resultType="int" parameterType="map" >
		 SELECT
				COUNT(1) AS cnt
			FROM
				STD_USS_MNG
		<where>
			1=1
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
			<!-- 재직구분 -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun2)" >
				AND RTR_YN = #{searchGubun2}
			</if>
			<!-- 고용구분 -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun3)" >
				AND EMP_TYPE = #{searchGubun3} 
			</if>
			<!-- 부서코드  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun4)" >
				AND DP_CD = #{searchGubun4}
			</if>
			<!-- 직급(권한)코드  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun5)" >
				AND USS_AUTH_CD = #{searchGubun5}
			</if>
		</where>
	</select>
	<!-- ID 체크 -->
	<select id="idCheckRepetition" resultType="int" parameterType="map">
		SELECT COUNT(1) AS ID_CHECK FROM STD_USS_MNG WHERE USS_ID = #{uss_id}
	</select>
	<!-- 사원번호 체크 -->
	<select id="emNoCheckRepetition" resultType="int" parameterType="map">
		SELECT COUNT(1) AS ID_CHECK FROM STD_USS_MNG WHERE USS_EM_NO = #{uss_em_no}
	</select>
	<!-- 사용자 등록 -->
	<insert id="ussInsert" parameterType="map" >
		INSERT INTO STD_USS_MNG(USS_ID, USS_PWD, USS_NM, USS_SEX, USS_BIRTH, USS_EMAIL, USS_TEL, USS_AUTH_CD, REG_DT, USS_EM_NO, DP_CD, JOIN_DT, RTR_YN, USS_BIRTH_DAY, USS_BIRTH_DAY_TYPE, WORK_YR_CNT, EMP_TYPE )

	     VALUES(#{uss_id}, #{uss_pwd}, #{uss_nm}, #{uss_sex}, #{uss_birth, jdbcType=VARCHAR}, #{uss_email, jdbcType=VARCHAR}, #{uss_tel, jdbcType=VARCHAR}, #{uss_auth_cd, jdbcType=VARCHAR}, SYSDATE, #{uss_em_no, jdbcType=VARCHAR}, #{dp_cd, jdbcType=VARCHAR}, #{join_dt, jdbcType=VARCHAR}, #{rtr_yn}, #{uss_birth_day, jdbcType=VARCHAR}, #{uss_birth_day_type, jdbcType=VARCHAR}, #{work_yr_cnt}, #{emp_type, jdbcType=VARCHAR})
	</insert>
	
	<!-- 사용자 상세조회 -->
	<select id="getUssView" resultType="HashMap" parameterType="map">
		SELECT
		  A.USS_ID
		  , A.USS_NM
		  , A.USS_BIRTH
		  , A.USS_SEX
		  , A.USS_TEL
		  , A.USS_EMAIL
		  <!-- , A.USS_AUTH_CD, --> <!-- 권한 매핑 테이블 미사용시 -->
		  , B.AUTHOR_CODE AS USS_AUTH_CD	<!-- 권한 매핑 테이블 사용시 --> 
		  , CASE
		        WHEN A.USS_SEX = 'M' THEN '남자'
		        WHEN A.USS_SEX = 'W' THEN '여자'
		        ELSE ''
		    END USS_SEX_VAL
		  , A.USS_EM_NO
		  , C.CD_NM AS USS_AUTH_NM	<!-- 권한 매핑 테이블 사용시 -->
		  , A.DP_CD
		  , D.DP_NM
		  <!-- 컬럼 추가에 따른 쿼리 변경 - 2022.01.03  -->
		  , A.JOIN_DT /*입사일*/
		  , A.RTR_DT  /*퇴사일*/
		  , A.RTR_YN  /*퇴사여부*/
		  , A.USS_BIRTH_DAY /*생일(월-일)*/
		  , A.USS_BIRTH_DAY_TYPE /*생일 음/양력 구분*/
		  , A.WORK_YR_CNT /*근속년수*/
		  , A.EMP_TYPE /*고용구분*/
		  , E.CD_NM /*고용구분 명칭*/ AS EMP_TYPE_NM
		  , A.RTR_RSN /*퇴사사유코드*/
		  , (SELECT S.CD_NM FROM STD_CD_MNG S WHERE S.CD = A.RTR_RSN) /*퇴사사유 명칭*/ AS RTR_RSN_NM
		  , A.BIR_CAL_SEQ /*생일캘린더번호*/
		FROM
		  	STD_USS_MNG A
			<!-- LEFT OUTER JOIN STD_AUT_INFO B ON B.AUTHOR_CODE = A.USS_AUTH_CD --><!-- 사용자테이블에 권한 컬럼 사용시 및 권한 매핑 테이블 미사용 -->
			LEFT OUTER JOIN STD_AUT_ROLE_MAP B ON A.USS_ID = B.SCRTY_DTRMN_TRGET_ID
			LEFT OUTER JOIN STD_CD_MNG C ON C.UP_CD IN ('CD0005', 'CD0006') AND C.CD_VAL = B.AUTHOR_CODE
			LEFT OUTER JOIN (
				SELECT 
					CD AS DP_CD, LTRIM (SYS_CONNECT_BY_PATH (CD_NM, ' > '), ' > ') AS DP_NM
				FROM STD_CD_MNG
				  START WITH UP_CD = 'CD0008'
				  CONNECT BY PRIOR CD = UP_CD
				ORDER SIBLINGS BY CD_ORD ASC
			) D ON D.DP_CD = A.DP_CD
			LEFT OUTER JOIN STD_CD_MNG E ON (E.CD = A.EMP_TYPE)
        WHERE
			A.USS_ID = #{uss_id}
		<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(uss_pwd)" >
			AND A.USS_PWD = #{uss_pwd}
		</if>
	</select>
	
	<!-- 사용자 수정 -->
	<update id="ussUpdate" parameterType="map" >
		UPDATE std_uss_mng SET
			uss_nm = #{uss_nm}
			, uss_birth = #{uss_birth, jdbcType=VARCHAR}
			, uss_sex = #{uss_sex, jdbcType=VARCHAR}
			, uss_tel = #{uss_tel, jdbcType=VARCHAR}
			, uss_email = #{uss_email, jdbcType=VARCHAR}
			, uss_em_no = #{uss_em_no, jdbcType=VARCHAR}
			, uss_auth_cd = #{uss_auth_cd, jdbcType=VARCHAR}
			, dp_cd = #{dp_cd, jdbcType=VARCHAR}
			<!-- 컬럼 추가에 따른 쿼리 변경 - 2022.01.03  -->
			, join_dt = #{join_dt, jdbcType=VARCHAR}
			, rtr_yn = #{rtr_yn, jdbcType=VARCHAR}
			, rtr_dt = #{rtr_dt, jdbcType=VARCHAR}
			, uss_birth_day = #{uss_birth_day, jdbcType=VARCHAR}
			, uss_birth_day_type = #{uss_birth_day_type, jdbcType=VARCHAR}
			, work_yr_cnt = #{work_yr_cnt}
			, emp_type = #{emp_type, jdbcType=VARCHAR}
			, rtr_rsn = #{rtr_rsn, jdbcType=VARCHAR}
			, bir_cal_seq = #{bir_cal_seq}
		<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(uss_pwd)" >
			, uss_pwd = #{uss_pwd}
		</if>
		WHERE uss_id = #{uss_id}
	</update> 
	
	<!-- 사용자 삭제 -->
	<delete id="ussDelete" parameterType="map" >
		DELETE FROM std_uss_mng WHERE uss_id = #{uss_id}
		<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(uss_pwd)" >
			AND uss_pwd = #{uss_pwd}
		</if>
	</delete>
	
	<!-- 팝업 사용자 검색 조회  -->
	<select id="getUssListPopup" resultType="hashMap" parameterType="map" >
		 SELECT
				A.USS_ID
				, A.USS_NM
				, A.USS_BIRTH
				, A.USS_EMAIL
				, B.AUTHOR_CODE AS USS_AUTH_CD	<!-- 권한 매핑 테이블 사용시 --> 
				, A.USS_AUTH_CD
				, A.USS_TEL
				, A.USS_EM_NO
				, C.AUTHOR_NM AS USS_AUTH_NM	<!-- 권한 매핑 테이블 사용시 -->
				, A.DP_CD
				, D.CD_NM AS DP_NM
			FROM
				STD_USS_MNG A
				LEFT OUTER JOIN STD_AUT_ROLE_MAP B ON A.USS_ID = B.SCRTY_DTRMN_TRGET_ID
				LEFT OUTER JOIN STD_AUT_INFO C ON C.AUTHOR_CODE = B.AUTHOR_CODE
				LEFT OUTER JOIN STD_CD_MNG D ON D.CD = A.DP_CD
		<where>
			1=1
			<!-- 퇴사 사원 조회 제외 - 2022.01.05 : BEGIN  -->
			AND (A.RTR_YN IS NULL OR A.RTR_YN != 'Y')
			<!-- 퇴사 사원 조회 제외 - 2022.01.05 : END  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND A.USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND A.USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(not_uss_id)" >
				AND A.USS_ID != #{not_uss_id}
			</if>
			
		</where>
		ORDER BY REG_DT DESC
	</select>
	<!-- 팝업 사용자 검색 총건수  -->
	<select id="getUssTotCountPopup" resultType="int" parameterType="map" >
		 SELECT
				COUNT(1) AS cnt
			FROM
				STD_USS_MNG
		<where>
			1=1
			<!-- 퇴사 사원 조회 제외 - 2022.01.05 : BEGIN  -->
			AND (RTR_YN IS NULL OR RTR_YN != 'Y')
			<!-- 퇴사 사원 조회 제외 - 2022.01.05 : END  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(not_uss_id)" >
				AND USS_ID != #{not_uss_id}
			</if>
		</where>
	</select>
	<!-- 부서목록 조회 -->
	<select id="getUssDepartList" resultType="hashMap" parameterType="map" >
		SELECT
		  cd AS dp_cd
		  , LTRIM (SYS_CONNECT_BY_PATH (cd_nm, ' > '), ' > ') AS dp_nm
		FROM std_cd_mng
		  START WITH up_cd = 'CD0008'
		  CONNECT BY PRIOR cd = up_cd
		ORDER SIBLINGS BY cd_ord ASC
	</select>
	
	<!-- 결재라인 삭제 -->
	<delete id="deleteAprvLine" parameterType="map" >
		DELETE FROM STD_APRV_LINE_INFO 
		 WHERE EMP_NO = #{uss_id}
	</delete>
	
	<!-- 결재라인 생성 -->
	<insert id="insertAprvLine" parameterType="map" >
		INSERT INTO STD_APRV_LINE_INFO(
			  EMP_NO
			, APRV_ORDR
			, REFE_YN
			, APRV_EMP_NO
		) VALUES (
			  #{emp_no, jdbcType=VARCHAR}
			, #{aprv_ordr, jdbcType=VARCHAR}
			, #{refe_yn, jdbcType=VARCHAR}
			, #{aprv_emp_no, jdbcType=VARCHAR}
		)
	</insert>
	
	<!-- 재직중인 사원만 조회  -->
	<select id="getWorkUssList" parameterType="map" resultType="hashMap">
		SELECT
				A.USS_ID
				, A.USS_NM
				, A.USS_BIRTH
				, A.USS_EMAIL
				<!-- , A.USS_AUTH_CD --> <!-- 권한 매핑 테이블 미사용시 -->
				, B.AUTHOR_CODE AS USS_AUTH_CD	<!-- 권한 매핑 테이블 사용시 --> 
				, A.USS_AUTH_CD
				, A.USS_TEL
				, A.USS_EM_NO
				, C.AUTHOR_NM AS USS_AUTH_NM	<!-- 권한 매핑 테이블 사용시 -->
				, A.DP_CD
				, D.CD_NM AS DP_NM
				, A.EMP_TYPE
				, (SELECT S.CD_NM FROM STD_CD_MNG S WHERE S.CD = A.EMP_TYPE) AS EMP_TYPE_NM /*고용구분명칭*/
				, A.RTR_YN /*재직구분*/
				, A.USS_BIRTH_DAY /*생일(월-일)*/
			    , A.USS_BIRTH_DAY_TYPE /*생일 음/양력 구분*/
			    , A.WORK_YR_CNT /*근속년수*/
			    , A.EMP_TYPE /*고용구분*/
			    , E.CD_NM /*고용구분 명칭*/ AS EMP_TYPE_NM
			    , A.RTR_RSN /*퇴사사유코드*/
			    , (SELECT S.CD_NM FROM STD_CD_MNG S WHERE S.CD = A.RTR_RSN) /*퇴사사유 명칭*/ AS RTR_RSN_NM
			    , A.BIR_CAL_SEQ /*생일캘린더번호*/
			FROM
				STD_USS_MNG A
				<!-- LEFT OUTER JOIN STD_AUT_INFO B ON B.AUTHOR_CODE = A.USS_AUTH_CD --><!-- 사용자테이블에 권한 컬럼 사용시 및 권한 매핑 테이블 미사용 -->
				LEFT OUTER JOIN STD_AUT_ROLE_MAP B ON A.USS_ID = B.SCRTY_DTRMN_TRGET_ID
				LEFT OUTER JOIN STD_AUT_INFO C ON C.AUTHOR_CODE = B.AUTHOR_CODE
				LEFT OUTER JOIN STD_CD_MNG D ON D.CD = A.DP_CD
				LEFT OUTER JOIN STD_CD_MNG E ON (E.CD = A.EMP_TYPE)
		   WHERE
		      A.RTR_YN IS NULL OR A.RTR_YN != 'Y'
	</select>
	
	<!-- 생일 캘린더 번호 수정  -->
	<update id="updateBirCalSeq" parameterType="map">
		UPDATE STD_USS_MNG
		   SET BIR_CAL_SEQ = #{bir_cal_seq}
		 WHERE USS_ID = #{uss_id} 
	</update>
	
	<!-- 근속년수 업데이트 +1씩 수정  -->
	<update id="updateWorkYrCnt" parameterType="map">
		UPDATE STD_USS_MNG
		   SET WORK_YR_CNT = (WORK_YR_CNT + 1)
		 WHERE (RTR_YN IS NULL OR RTR_YN != 'Y')
		   AND WORK_YR_CNT IS NOT NULL   
	</update> 
</mapper>
