<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="vctMng">
	
	<!-- 휴가부여일수 총 건수  -->
	<select id="getVctDayTotCount" resultType="int" parameterType="map">
		SELECT
			   COUNT(1) AS cnt
		  FROM STD_USS_MNG A
		<where>
			1=1
			<!-- 재직구분 : 파라미터 값이 존재하면 파라미터 값에 따라 조회, 파라미터 값이 존재하지 않으면 '재직중' 조회  -->
		  	<choose>
		  		<when test='searchGubun3 == "Y"'>
		  			AND A.RTR_YN = #{searchGubun3}
		  		</when>
		  		<otherwise>
		  			AND ( A.RTR_YN IS NULL OR A.RTR_YN != 'Y' )
		  		</otherwise>
		  	</choose>
			<!-- ID/성명 : 키워드 값이 있으면 구분에 따라 조회  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND A.USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND A.USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
		</where>
	</select>
	
	
	<!-- 휴가부여일수 목록 조회   -->
	<select id="getVctDayList" resultType="hashMap" parameterType="map">
		SELECT
		       A.USS_ID						/*사원ID*/
		     , A.USS_NM						/*사원명*/
		     , A.JOIN_DT					/*입사일*/
		     , A.WORK_YR_CNT				/*근속년수*/
		     , A.RTR_DT						/*퇴사일*/
		     , A.RTR_YN						/*퇴사여부*/
		     , B.VCT_GRNT_DAY				/*휴가부여일수*/
		     , #{searchGubun2} AS STDD_YR	/*기준년도*/
		  FROM STD_USS_MNG A
		  LEFT OUTER JOIN (
		  
		                    SELECT STDD_YR
		                         , USS_ID
		                         , VCT_GRNT_DAY
		                      FROM VCT_DAY_MNG
		                     WHERE STDD_YR = #{searchGubun2}
		                      
		                  ) B ON (B.USS_ID = A.USS_ID)
		                  
		 <where>
		  	1=1
		  	<!-- 재직구분 : 파라미터 값이 존재하면 파라미터 값에 따라 조회, 파라미터 값이 존재하지 않으면 '재직중' 조회  -->
		  	<choose>
		  		<when test='searchGubun3 == "Y"'>
		  			AND A.RTR_YN = #{searchGubun3}
		  		</when>
		  		<otherwise>
		  			AND ( A.RTR_YN IS NULL OR A.RTR_YN != 'Y' )
		  		</otherwise>
		  	</choose>
		  	<!-- ID/성명 : ID/성명 : 키워드 값이 있으면 구분에 따라 조회 -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND A.USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND A.USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
		  </where>
		  
		  ORDER BY A.USS_NM ASC	  
		
	</select>
	
	<!-- 휴가부여일수 등록/수정 : MERGE  -->
	<insert id="mergeVctDay" parameterType="map">
		MERGE INTO VCT_DAY_MNG A
		USING (
			<foreach collection="vctMapList" item="vctMap" separator="UNION">
				SELECT  #{vctMap.stdd_yr} AS STDD_YR
				     ,  #{vctMap.uss_id} AS USS_ID
				     ,  #{vctMap.vct_grnt_day} AS VCT_GRNT_DAY
				  FROM DUAL
			</foreach>
		
		) B
	
		   ON (    A.STDD_YR = B.STDD_YR 
		       AND A.USS_ID = B.USS_ID
		       )
		 WHEN NOT MATCHED THEN
		 INSERT ( STDD_YR
		      ,   USS_ID
		      ,   VCT_GRNT_DAY
		 )
		 VALUES ( B.STDD_YR
		      ,   B.USS_ID
		      ,   B.VCT_GRNT_DAY
		 )
		 WHEN MATCHED THEN
		 UPDATE
		    SET A.VCT_GRNT_DAY = B.VCT_GRNT_DAY       
	</insert>
	
</mapper>
