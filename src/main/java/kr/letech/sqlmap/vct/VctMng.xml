<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="vctMng">
	
	<!-- 휴가부여일수 총 건수  -->
	<select id="getVctDayTotCount" resultType="int" parameterType="map">
		SELECT
			   COUNT(1) AS cnt
		  FROM STD_USS_MNG A
		<where>
			1=1
			<!-- 입사일 이나 등록일자가 기준년도보다 크거나 같은 직원 조회  -->
			AND ( SUBSTR(TO_CHAR(A.REG_DT, 'YYYY-MM-DD'), 1, 4) <![CDATA[<=]]> #{searchGubun2} 
			      OR SUBSTR(A.JOIN_DT, 1, 4) <![CDATA[<=]]> #{searchGubun2} )  
			<!-- 재직구분 : 파라미터 값이 존재하면 파라미터 값에 따라 조회, 파라미터 값이 존재하지 않으면 '재직중' 조회  -->
		  	<choose>
		  		<when test='searchGubun3 == "Y"'>
		  			AND A.RTR_YN = #{searchGubun3}
		  		</when>
		  		<otherwise>
		  			AND ( A.RTR_YN IS NULL OR A.RTR_YN != 'Y' )
		  		</otherwise>
		  	</choose>
			<!-- ID/성명 : 키워드 값이 있으면 구분에 따라 조회  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND A.USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND A.USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
		</where>
	</select>
	
	
	<!-- 휴가부여일수 목록 조회   -->
	<select id="getVctDayList" resultType="hashMap" parameterType="map">
		SELECT
		       A.USS_ID						/*사원ID*/
		     , A.USS_NM						/*사원명*/
		     , A.JOIN_DT					/*입사일*/
		     , A.WORK_YR_CNT				/*근속년수*/
		     , A.RTR_DT						/*퇴사일*/
		     , A.RTR_YN						/*퇴사여부*/
		     , B.VCT_GRNT_DAY				/*휴가부여일수*/
		     , #{searchGubun2} AS STDD_YR	/*기준년도*/
		  FROM STD_USS_MNG A
		  LEFT OUTER JOIN (
		  
		                    SELECT STDD_YR
		                         , USS_ID
		                         , VCT_GRNT_DAY
		                      FROM VCT_DAY_MNG
		                     WHERE STDD_YR = #{searchGubun2}
		                      
		                  ) B ON (B.USS_ID = A.USS_ID)
		                  
		 <where>
		  	1=1
		  	<!-- 입사일 이나 등록일자가 기준년도보다 크거나 같은 직원 조회  -->
		  	AND ( SUBSTR(TO_CHAR(A.REG_DT, 'YYYY-MM-DD'), 1, 4) <![CDATA[<=]]> #{searchGubun2} 
			      OR SUBSTR(A.JOIN_DT, 1, 4) <![CDATA[<=]]> #{searchGubun2} )  
		  	<!-- 재직구분 : 파라미터 값이 존재하면 파라미터 값에 따라 조회, 파라미터 값이 존재하지 않으면 '재직중' 조회  -->
		  	<choose>
		  		<when test='searchGubun3 == "Y"'>
		  			AND A.RTR_YN = #{searchGubun3}
		  		</when>
		  		<otherwise>
		  			AND ( A.RTR_YN IS NULL OR A.RTR_YN != 'Y' )
		  		</otherwise>
		  	</choose>
		  	<!-- ID/성명 : ID/성명 : 키워드 값이 있으면 구분에 따라 조회 -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND A.USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND A.USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
		  </where>
		  
		  ORDER BY A.USS_NM ASC	  
		
	</select>
	
	<!-- 휴가부여일수 등록/수정 : MERGE  -->
	<insert id="mergeVctDay" parameterType="map">
		MERGE INTO VCT_DAY_MNG A
		USING (
			<foreach collection="vctMapList" item="vctMap" separator="UNION">
				SELECT  #{vctMap.stdd_yr} AS STDD_YR
				     ,  #{vctMap.uss_id} AS USS_ID
				     ,  #{vctMap.vct_grnt_day} AS VCT_GRNT_DAY
				  FROM DUAL
			</foreach>
		
		) B
	
		   ON (    A.STDD_YR = B.STDD_YR 
		       AND A.USS_ID = B.USS_ID
		       )
		 WHEN NOT MATCHED THEN
		 INSERT ( STDD_YR
		      ,   USS_ID
		      ,   VCT_GRNT_DAY
		 )
		 VALUES ( B.STDD_YR
		      ,   B.USS_ID
		      ,   B.VCT_GRNT_DAY
		 )
		 WHEN MATCHED THEN
		 UPDATE
		    SET A.VCT_GRNT_DAY = B.VCT_GRNT_DAY       
	</insert>
	
	
	<!-- 휴가현황조회 사용자 총 건수  -->
	<select id="getVctInfTotCount" resultType="int" parameterType="map">
		SELECT
			   COUNT(1) AS cnt
		  FROM STD_USS_MNG A
		<where>
			1=1
			<!-- 입사일 이나 등록일자가 기준년도보다 크거나 같은 직원 조회  -->
			AND ( TO_CHAR(A.REG_DT, 'YYYY') <![CDATA[<=]]> #{searchGubun2} 
			      OR SUBSTR(A.JOIN_DT, 1, 4) <![CDATA[<=]]> #{searchGubun2} )  
			<!-- 재직구분 : 파라미터 값이 존재하면 파라미터 값에 따라 조회, 파라미터 값이 존재하지 않으면 '재직중' 조회  -->
		  	<choose>
		  		<when test='searchGubun3 == "Y"'>
		  			AND A.RTR_YN = #{searchGubun3}
		  		</when>
		  		<otherwise>
		  			AND ( A.RTR_YN IS NULL OR A.RTR_YN != 'Y' )
		  		</otherwise>
		  	</choose>
			<!-- ID/성명 : 키워드 값이 있으면 구분에 따라 조회  -->
			<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
				<choose>
					<when test='searchGubun == "01"' >
				AND A.USS_ID LIKE '%' || #{searchField} || '%'
					</when>
					<when test='searchGubun == "02"' >
				AND A.USS_NM LIKE '%' || #{searchField} || '%'	
					</when>
				</choose>
			</if>
		</where>
	</select>
	
	<!-- 휴가현황조회 사용자 목록 조회   -->
	<select id="getVctInfList" resultType="hashMap" parameterType="map">
		  SELECT
		           A.USS_ID
		         , A.USS_NM
		         , A.JOIN_DT
		         , A.REG_DT
		         , A.RTR_YN
		         , A.RTR_DT
		         , A.WORK_YR_CNT - ( TO_NUMBER(TO_CHAR(SYSDATE, 'YYYY')) - TO_NUMBER(#{searchGubun2}) ) AS WORK_YR_CNT
		         , A.EMP_TYPE
		         , (SELECT S.CD_NM FROM STD_CD_MNG S WHERE S.CD = A.EMP_TYPE) AS EMP_TYPE_NM
		         , B.APRV_NO
		         , B.PROJ_CD
		         , (SELECT S.CD_NM FROM STD_CD_MNG S WHERE S.CD = B.PROJ_CD) AS PROJ_NM
		         , B.REPT_DP_CD AS DP_CD
		         , (SELECT S.CD_NM FROM STD_CD_MNG S WHERE S.CD = B.REPT_DP_CD) AS DP_NM
		         , B.REPT_AUTH_CD  AS AUTH_CD
		         , (SELECT S.AUTHOR_NM FROM STD_AUT_INFO S WHERE S.AUTHOR_CODE = B.REPT_AUTH_CD) AS AUTH_NM
		         , #{searchGubun2} AS STDD_YR
		      FROM STD_USS_MNG A
		      LEFT OUTER JOIN (
		      
		                          SELECT
		                                C.APRV_NO
		                              , C.REPT_APRV_NO
		                              , C.PROJ_CD
		                              , C.REPT_DP_CD
		                              , C.REPT_AUTH_CD
		                           FROM STD_APRV_MNG C
		                           INNER JOIN ( SELECT
		                                              REPT_APRV_NO
		                                            , MAX(TO_NUMBER(APRV_NO)) AS MAX_APRV_NO
		                                        FROM STD_APRV_MNG
		                                        WHERE TO_CHAR(MODI_DT, 'YYYY') = #{searchGubun2}
		                                        GROUP BY REPT_APRV_NO
		                                        ORDER BY MAX(TO_NUMBER(APRV_NO)) DESC ) D ON (C.APRV_NO = D.MAX_APRV_NO) 
		                                        
		                     ) B ON  (A.USS_ID = B.REPT_APRV_NO)
		        <where>
		              1=1
		          AND ( TO_CHAR(A.REG_DT, 'YYYY') <![CDATA[<=]]> #{searchGubun2}
		                OR SUBSTR(A.JOIN_DT, 1, 4)<![CDATA[<=]]> #{searchGubun2} ) /*입사년도*/
		          <!-- 재직구분 : 파라미터 값이 존재하면 파라미터 값에 따라 조회, 파라미터 값이 존재하지 않으면 '재직중' 조회  -->
				  	<choose>
				  		<when test='searchGubun3 == "Y"'>
				  			AND A.RTR_YN = #{searchGubun3}
				  		</when>
				  		<otherwise>
				  			AND ( A.RTR_YN IS NULL OR A.RTR_YN != 'Y' )
				  		</otherwise>
				  	</choose>
				  	<!-- ID/성명 : ID/성명 : 키워드 값이 있으면 구분에 따라 조회 -->
					<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchField)" >
						<choose>
							<when test='searchGubun == "01"' >
						AND A.USS_ID LIKE '%' || #{searchField} || '%'
							</when>
							<when test='searchGubun == "02"' >
						AND A.USS_NM LIKE '%' || #{searchField} || '%'	
							</when>
						</choose>
					</if>
					<!-- 고용구분  -->
					<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun4)">
						AND A.EMP_TYPE = #{searchGubun4}
					</if>
					<!-- 직급(권한)  -->
					<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun5)">
						AND B.REPT_AUTH_CD = #{searchGubun5}
					</if>
					
					<!-- 프로젝트  -->
					<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(searchGubun6)">
						AND B.PROJ_CD = #{searchGubun6}
					</if>
		        
		        </where> 
		                  
		  
		  ORDER BY A.USS_NM ASC	  
		
	</select>
	
</mapper>
