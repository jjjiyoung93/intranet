<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codeMng">	
	
	<!-- 코드 전체 조회 -->
	<select id="getAllCodeList" resultType="HashMap">
		SELECT *
  		  FROM STD_CD_MNG
  		 WHERE use_yn = 'Y'
	</select>
	
	<!-- 상위 공통코드 목록 로딩시  -->
	<select id="getOneCodeList" resultType="HashMap" parameterType="map" >
		SELECT
		      cd,
		      cd_nm,
		      up_cd,
		      levl,
		      cd_val
		FROM
		    STD_CD_MNG
		WHERE levl = '1'
		<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(notcode)" >
		AND cd != #{notcode}
		</if>
		ORDER BY cd
	</select>	
	
	<!-- 하위 공통코드 목록 로딩시  -->
	 <select id="getCodeList" resultType="HashMap" parameterType="map" >
		   SELECT cd
		     ,cd_nm
		     ,up_cd
		     ,levl
		     ,cd_ord
		     ,cd_val
		  FROM STD_CD_MNG
		  WHERE up_cd  = #{up_cd, javaType=String ,jdbcType=VARCHAR}
		  <!-- 2022.01.18 프로젝트 코드 조회 시 종료 프로젝트 제외 : BEGIN  -->
		  <if test='up_cd=="CD0002"'>
			  <if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(y_only)">
			  		<if test='y_only=="Y"'>
					   AND (CD_VAL IS NULL OR CD_VAL != 'N')
			  		</if>
			  </if>
		  
		  </if>
		  <!-- 2022.01.18 프로젝트 코드 조회 시 종료 프로젝트 제외 : END  -->
		  
		  <if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(cd_val)" >
		  AND CD_VAL = #{cd_val}
		  </if>
		  <if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(code)" >
		  OR CD = #{code, javaType=String ,jdbcType=VARCHAR}
		  </if>
		  ORDER BY  levl, cd_ord
	 </select>
	 
	 <!-- 코드상세정보 가져오기  -->
	<select id="getCodeView" resultType="HashMap" parameterType="map" >
		SELECT cd
		     ,cd_nm
		     ,up_cd
		     ,levl
		     ,cd_ord
		     ,cd_val
		FROM STD_CD_MNG
		WHERE cd = #{cd, javaType=String ,jdbcType=VARCHAR}
	</select>	
	
	<!-- 상위 코드 등록 -->
	<insert id="insert" parameterType="map">
		<selectKey keyProperty="cd" resultType="String" order="BEFORE">
			SELECT 
				'CD' ||
				SUBSTR('0000' || TO_CHAR(NVL(MAX(TO_NUMBER(SUBSTR(cd,-4))),0)+1),-4)
			FROM STD_CD_MNG WHERE up_cd = #{up_cd}
		</selectKey>/* codeMng.insert */
		INSERT INTO STD_CD_MNG (
			 cd
			,cd_nm
			,up_cd
			,levl
			,cd_val
			,cd_ord
		)VALUES(
			#{cd}
			,#{cd_nm}
			,#{up_cd}
			,#{levl}
			,#{cd_val}
			,#{cd_ord}
		)
	</insert>
	
	<!-- 하위코드 등록 -->
	<insert id="insertLow" parameterType="map">
		<selectKey keyProperty="cd" resultType="String" order="BEFORE">
			SELECT 
				#{up_cd} ||
				SUBSTR('000' || TO_CHAR(NVL(MAX(TO_NUMBER(SUBSTR(cd,-3))),0)+1),-3)
			FROM STD_CD_MNG WHERE up_cd = #{up_cd}
		</selectKey>
		INSERT INTO STD_CD_MNG (
			 cd
			,cd_nm
			,up_cd
			,levl
			,cd_val
			,cd_ord
		)VALUES(
			#{cd}
			,#{cd_nm}
			,#{up_cd}
			,#{levl}
			,#{cd_val}
			,#{cd_ord}
		)
	</insert>
	
	<!-- 하위코드 정렬 최대값 가져오기  -->
	<select id="getMaxOrdr" resultType="HashMap" parameterType="map" >
		SELECT TO_CHAR(MAX(TO_NUMBER(cd_ord))) MAX_ORDR
		FROM STD_CD_MNG    
		WHERE up_cd = #{cd}
	</select>	
	
	<!-- 수정 -->
	<update id="updateNm"  parameterType="map">
		UPDATE STD_CD_MNG
		SET cd_nm = #{cd_nm}
		<if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(cd_val)" >
		,cd_val = #{cd_val}
		</if>
		WHERE cd = #{cd}
	</update>
	
	<!-- 삭제 -->
	<delete id="delete" parameterType="map">
		DELETE FROM STD_CD_MNG WHERE cd = #{cd}
	</delete>

	<!-- 전체삭제 -->
	<delete id="deleteAll" parameterType="map">
		DELETE FROM STD_CD_MNG WHERE up_cd = #{cd}
	</delete>
	
	<select id="getCodeCdNm" resultType="String">
		SELECT 
				cd_nm 
			FROM 
				STD_CD_MNG 
				WHERE up_cd = #{up_cd}
				AND cd_val = #{cd_val}
	</select>
	
	<!-- 갯수  -->
	<select id="getCodeCnt" parameterType="map" resultType="HashMap">
		SELECT COUNT(CD) as CNT
		  FROM STD_CD_MNG
		 WHERE 1=1
		  <if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(cd)" >
		  	AND CD = #{cd} 
		  </if>
		  <if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(cd_nm)" >
		  	AND CD_NM = #{cd_nm}
		  </if>
		  <if test="@kr.letech.cmm.util.DBSupport@isNotEmpty(up_cd)" >
		  	AND UP_CD = #{up_cd}
		  </if>
	</select>
	
</mapper>
